<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Orçamento – Livro</title>
  <style>
    :root { --accent:#111; --muted:#666; --line:#ddd; }
    * { box-sizing: border-box; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; background: #f6f6f6; color:#111; }
    header { background:#fff; border-bottom:1px solid var(--line); padding: 16px 20px; display:flex; gap:16px; align-items:center; }
    #logo { width: 90px; height: 90px; object-fit: contain; border:1px dashed #bbb; background:#fafafa; }
    .header-text { display:flex; flex-direction:column; gap:2px; }
    .header-text h1 { margin:0; font-size: 18px; letter-spacing: .3px; }
    .header-text .sub { color:var(--muted); font-size: 12px; }

    main { max-width: 1024px; margin: 0 auto; padding: 20px; display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    section { background:#fff; border:1px solid var(--line); padding:16px; }
    section h2 { margin:0 0 10px; font-size: 14px; letter-spacing:.3px; color:#333; }
    label { display:block; font-size:12px; color:#333; margin:8px 0 4px; }
    input[type="text"], input[type="number"], select, textarea { width:100%; padding:8px; border:1px solid var(--line); font-size: 13px; background:#fff; }
    textarea { min-height: 84px; resize: vertical; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; }
    button { background:#111; color:#fff; border:0; padding:10px 14px; font-size:13px; cursor:pointer; }
    button.secondary { background:#555; }

    /* Quadro de orçamento (o que vai para o PDF) */
    #orcamento { background:#fff; border:1px solid var(--line); padding:20px; }
    .orc-header { display:flex; align-items:center; gap:16px; border-bottom:1px solid var(--line); padding-bottom:12px; margin-bottom:12px; }
    .orc-header img { width:90px; height:90px; object-fit:contain; border:1px solid #eee; background:#fafafa; }
    .orc-header .htxt h3 { margin:0; font-size:18px; }
    .orc-header .htxt p { margin:2px 0; color:var(--muted); font-size:12px; }

    .kv { display:grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; margin-bottom: 12px; }
    .kv div { font-size:12px; }
    .kv strong { display:block; color:#333; }

    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border:1px solid var(--line); padding:8px; font-size:12px; vertical-align: top; }
    th { background:#fafafa; text-align:left; }
    tfoot td { font-weight:bold; }

    .muted { color:var(--muted); font-size:11px; }

    /* for PDF page-break handling */
    .page-break { page-break-after: always; }

    @media print {
      header, main > section.controls { display:none; }
      body { background:#fff; }
    }
  </style>
</head>
<body>
  <header>
    <img id="logo" alt="Logo" />
    <div class="header-text">
      <h1>Calculadora de Orçamento – Livro</h1>
      <div class="sub">Gera documento em PDF no estilo de orçamento de gráfica.</div>
    </div>
  </header>

  <main>
    <section class="controls">
      <h2>Configurações</h2>
      <label for="logoInput">Logo (PNG/JPG)</label>
      <input id="logoInput" type="file" accept="image/*" />

      <div class="row">
        <div>
          <label for="empresa">Empresa/Produtor</label>
          <input id="empresa" type="text" placeholder="Ex.: Estúdio KCM / Seu nome" />
        </div>
        <div>
          <label for="cnpj">CNPJ/CPF (opcional)</label>
          <input id="cnpj" type="text" placeholder="Ex.: 00.000.000/0001-00" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="cliente">Cliente</label>
          <input id="cliente" type="text" placeholder="Nome do cliente" />
        </div>
        <div>
          <label for="validade">Validade do orçamento (dias)</label>
          <input id="validade" type="number" value="30" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="titulo">Título do livro</label>
          <input id="titulo" type="text" value="História do PSF em Campina Grande" />
        </div>
        <div>
          <label for="autor">Autor(a)</label>
          <input id="autor" type="text" value="Erinaldo Guimarães" />
        </div>
      </div>

      <label for="pacote">Pacote</label>
      <select id="pacote">
        <option value="1">1) Ebook (PDF) + Distribuição Digital — R$ 1.200,00</option>
        <option value="2">2) Ebook (PDF + EPUB/MOBI) + Distribuição Digital — R$ 1.500,00</option>
        <option value="3">3) Ebook (PDF + Audiobook) + Distribuição Digital — R$ 2.200,00</option>
        <option value="4">4) Livro Impresso (serviços completos) — Escolher abaixo</option>
        <option value="5">5) Impresso + Ebook (PDF/EPUB/MOBI) — Escolher abaixo</option>
        <option value="6">6) Impresso + Ebook + Audiobook — Escolher abaixo</option>
      </select>

      <div id="suboptions"></div>

      <label for="obs">Observações (aparecem no PDF)</label>
      <textarea id="obs" placeholder="Observações, prazos, condições de pagamento, etc."></textarea>

      <div class="btns">
        <button id="btnAtualizar">Calcular/Atualizar</button>
        <button id="btnPDF" class="secondary">Gerar PDF</button>
      </div>
    </section>

    <section>
      <h2>Pré-visualização do Orçamento (PDF)</h2>
      <div id="orcamento">
        <div class="orc-header">
          <img id="pdfLogo" alt="Logo" />
          <div class="htxt">
            <h3>ORÇAMENTO DE PRODUÇÃO DE LIVRO</h3>
            <p id="empresaLinha">—</p>
            <p id="validadeLinha" class="muted">Validade: —</p>
          </div>
        </div>

        <div class="kv">
          <div><strong>Título:</strong><span id="kvTitulo">—</span></div>
          <div><strong>Autor(a):</strong><span id="kvAutor">—</span></div>
          <div><strong>Cliente:</strong><span id="kvCliente">—</span></div>
          <div><strong>Data:</strong><span id="kvData">—</span></div>
          <div><strong>Pacote selecionado:</strong><span id="kvPacote">—</span></div>
          <div><strong>Especificação de material:</strong><span id="kvMaterial">—</span></div>
        </div>

        <table id="tbl">
          <thead>
            <tr>
              <th style="width:50%">Descrição</th>
              <th style="width:25%">Detalhes</th>
              <th style="width:25%">Valor (R$)</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="2" style="text-align:right">TOTAL</td>
              <td id="tdTotal">R$ 0,00</td>
            </tr>
          </tfoot>
        </table>

        <p class="muted" id="obsLinha" style="margin-top:10px"></p>
      </div>
    </section>
  </main>

  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIPGdhUe1N7z3n2Rr8y1pYhlp4F7d2u6x7wA9r3o6rUo3wQxW3w3mA9a8Z2oXGvK9vQpH1zj8b6f0iCwQW3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    // --- TABELA DE PREÇOS FIXA (conforme documento em canvas) ---
    const PRICING = {
      1: { label: '1) Ebook (PDF) + Distribuição Digital', total: 1200.00, material: 'Ebook (PDF); capa frente; revisão; ficha/ISBN; distribuição digital.' },
      2: { label: '2) Ebook (PDF + EPUB/MOBI) + Distribuição Digital', total: 1500.00, material: 'Ebook PDF + EPUB/MOBI; capa frente; revisão; ficha/ISBN; distribuição digital.' },
      3: { label: '3) Ebook (PDF + Audiobook) + Distribuição Digital', total: 2200.00, material: 'Ebook (PDF) + audiobook (3–5h); capa frente; revisão; ficha/ISBN; distribuição digital.' },
      // Pacotes físicos com combinações específicas solicitadas
      4: {
        label: '4) Livro Impresso (serviços editoriais completos)',
        options: [
          {key:'4-500-eco', label:'500 ex. (Qualidade Econômica)', total: 11827.47, material:'Econômico: 150 págs., capa 2 cores (P&B), gramagem básica.'},
          {key:'4-500-pre', label:'500 ex. (Qualidade Premium)', total: 15514.37, material:'Premium: 176 págs., capa Triplex 250 g 4x4, miolo Offset 90 g, BOPP fosca, lombada quadrada.'}
        ]
      },
      5: {
        label: '5) Livro Impresso + Ebook (PDF/EPUB/MOBI) + Distribuição',
        options: [
          {key:'5-500-eco', label:'500 ex. (Qualidade Econômica)', total: 17134.41, material:'Econômico: 150 págs., capa 2 cores (P&B), gramagem básica + eBook (PDF/EPUB/MOBI).'},
          {key:'5-1000-pre', label:'1.000 ex. (Qualidade Premium)', total: 19937.61, material:'Premium: 176 págs., Triplex 250 g 4x4, Offset 90 g, BOPP fosca + eBook (PDF/EPUB/MOBI).'}
        ]
      },
      6: {
        label: '6) Livro Impresso + Ebook (PDF/EPUB/MOBI) + Audiobook + Distribuição',
        options: [
          {key:'6-500-eco', label:'500 ex. (Qualidade Econômica)', total: 20025.00, material:'Econômico: 150 págs., 2 cores; gramagem básica + eBook + audiobook (3–5h).'},
          {key:'6-1000-any', label:'1.000 ex. (Econômica ou Premium)', total: 22069.63, material:'Especificação conforme aprovação (econômica ou premium) + eBook + audiobook (3–5h).'}
        ]
      }
    };

    const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    const el = (id) => document.getElementById(id);

    function buildSuboptions() {
      const p = parseInt(el('pacote').value, 10);
      const wrap = el('suboptions');
      wrap.innerHTML = '';

      if ([4,5,6].includes(p)) {
        const s = document.createElement('select');
        s.id = 'combo';
        const opts = PRICING[p].options;
        opts.forEach(o => {
          const op = document.createElement('option');
          op.value = o.key; op.textContent = `${o.label} — ${fmt(o.total)}`;
          s.appendChild(op);
        });
        const lab = document.createElement('label');
        lab.textContent = 'Quantidade/Qualidade';
        wrap.appendChild(lab);
        wrap.appendChild(s);
      }
    }

    function render() {
      const empresa = el('empresa').value.trim() || '—';
      const cnpj = el('cnpj').value.trim();
      const cliente = el('cliente').value.trim() || '—';
      const validade = parseInt(el('validade').value || '30', 10);
      const titulo = el('titulo').value.trim() || '—';
      const autor = el('autor').value.trim() || '—';
      const pacote = parseInt(el('pacote').value, 10);
      const combo = el('combo') ? el('combo').value : null;
      const obs = el('obs').value.trim();

      // Cabeçalho
      el('empresaLinha').textContent = cnpj ? `${empresa} — ${cnpj}` : empresa;
      const dt = new Date();
      const d = dt.toLocaleDateString('pt-BR');
      el('validadeLinha').textContent = `Validade: ${validade} dias`;
      el('kvTitulo').textContent = titulo;
      el('kvAutor').textContent = autor;
      el('kvCliente').textContent = cliente;
      el('kvData').textContent = d;

      // Tabela
      const tbody = el('tbody');
      tbody.innerHTML = '';

      let total = 0; let materialDesc = '—'; let pacoteNome = PRICING[pacote].label;

      if ([1,2,3].includes(pacote)) {
        const row = document.createElement('tr');
        const a = document.createElement('td'); a.textContent = PRICING[pacote].label;
        const b = document.createElement('td'); b.textContent = PRICING[pacote].material;
        const c = document.createElement('td'); c.textContent = fmt(PRICING[pacote].total);
        row.appendChild(a); row.appendChild(b); row.appendChild(c);
        tbody.appendChild(row);
        total = PRICING[pacote].total;
        materialDesc = PRICING[pacote].material;
      } else {
        const opt = PRICING[pacote].options.find(o => o.key === combo) || PRICING[pacote].options[0];
        const row = document.createElement('tr');
        const a = document.createElement('td'); a.textContent = PRICING[pacote].label + ' — ' + opt.label;
        const b = document.createElement('td'); b.textContent = opt.material;
        const c = document.createElement('td'); c.textContent = fmt(opt.total);
        row.appendChild(a); row.appendChild(b); row.appendChild(c);
        tbody.appendChild(row);
        total = opt.total;
        materialDesc = opt.material;
        pacoteNome = PRICING[pacote].label + ' / ' + opt.label;
      }

      el('tdTotal').textContent = fmt(total);
      el('kvPacote').textContent = pacoteNome;
      el('kvMaterial').textContent = materialDesc;
      el('obsLinha').textContent = obs;
    }

    // Logo upload -> preview em header e PDF
    el('logoInput').addEventListener('change', (ev) => {
      const f = ev.target.files?.[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        el('logo').src = reader.result; // topo
        el('pdfLogo').src = reader.result; // PDF
      };
      reader.readAsDataURL(f);
    });

    // Seletores
    el('pacote').addEventListener('change', () => { buildSuboptions(); render(); });
    document.addEventListener('input', (e) => {
      if (['empresa','cnpj','cliente','validade','titulo','autor','obs','combo'].includes(e.target.id)) {
        render();
      }
    });

    // Botões
    el('btnAtualizar').addEventListener('click', render);
    el('btnPDF').addEventListener('click', () => {
      // Opções recomendadas para reduzir páginas em branco
      const opt = {
        margin:       [10,10,10,10],
        filename:     `Orcamento_Livro_${new Date().toISOString().slice(0,10)}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2, useCORS: true },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
      };
      const node = document.getElementById('orcamento');
      html2pdf().set(opt).from(node).save();
    });

    // Inicialização
    buildSuboptions();
    render();
  </script>
</body>
</html>
