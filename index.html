<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Orçamento – Multi‑pacotes (1–6) + Serviços (7)</title>
  <style>
    :root { --accent:#111; --muted:#666; --line:#ddd; }
    * { box-sizing: border-box; }
    html, body { height:100%; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; background: #f6f6f6; color:#111; }

    header { background:#fff; border-bottom:1px solid var(--line); padding: 12px 16px; display:flex; gap:16px; align-items:center; position:sticky; top:0; z-index:1; }
    .logos { display:flex; gap:10px; align-items:center; }
    .logos img { width: 80px; height: 80px; object-fit: contain; border:1px solid #eee; background:#fafafa; }
    .header-text { display:flex; flex-direction:column; gap:2px; }
    .header-text h1 { margin:0; font-size: 18px; letter-spacing: .3px; }
    .header-text .sub { color:var(--muted); font-size: 12px; }

    main { max-width: 1300px; margin: 0 auto; padding: 16px; display:flex; flex-direction:column; gap: 16px; }
    section { background:#fff; border:1px solid var(--line); }
    section h2 { margin:0; padding:12px 12px 0; font-size: 14px; letter-spacing:.3px; color:#333; }
    .pane { display:grid; grid-template-columns: minmax(360px, 1fr) 820px; gap: 12px; align-items:start; padding: 12px; }

    /* ===== Form ===== */
    label { display:block; font-size:12px; color:#333; margin:8px 0 4px; }
    input[type="text"], input[type="number"], select, textarea { width:100%; padding:8px; border:1px solid var(--line); font-size: 13px; background:#fff; }
    textarea { min-height: 84px; resize: vertical; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btns { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    button { background:#111; color:#fff; border:0; padding:10px 14px; font-size:13px; cursor:pointer; }
    button.secondary { background:#555; }
    button.soft { background:#888; }

    /* ===== A4 PREVIEW (fixo + pager) ===== */
    .a4-wrap { display:flex; justify-content:center; }
    .a4 { width:794px; height:1123px; background:#fff; border:1px solid var(--line); padding:18px; display:flex; flex-direction:column; overflow:auto; }
    /* esconder scrollbar sem quebrar o scroll programático */
    .a4::-webkit-scrollbar { width:0; height:0; }

    .pager { display:none; justify-content:space-between; align-items:center; gap:8px; margin:8px 0 0; }
    .pager .info { font-size:12px; color:#666; }
    .pager .btnPager { background:#f7f7f7; color:#111; border:1px solid var(--line); padding:6px 10px; cursor:pointer; }
    .pager .btnPager:disabled { opacity:.4; cursor:not-allowed; }

    .doc-header { display:flex; align-items:center; gap:16px; border-bottom:1px solid var(--line); padding-bottom:10px; margin-bottom:10px; }
    .doc-header .logos img { width:70px; height:70px; }
    .doc-header .htxt h3 { margin:0; font-size:18px; }
    .doc-header .htxt p { margin:2px 0; color:var(--muted); font-size:12px; }

    .kv { display:grid; grid-template-columns: 1fr 1fr; gap: 8px 16px; margin-bottom: 10px; }
    .kv div { font-size:12px; }
    .kv strong { display:block; color:#333; }

    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border:1px solid var(--line); padding:8px; font-size:12px; vertical-align: top; }
    thead { background:#fafafa; }
    tfoot td { font-weight:bold; }
    .muted { color:var(--muted); font-size:11px; }

    .orc-item { border:1px solid var(--line); padding:10px; margin: 10px 0; background:#fff; position:relative; page-break-inside: avoid; break-inside: avoid; }
    .orc-item h4 { margin:0 0 6px 0; font-size:13px; }
    .rm { position:absolute; top:8px; right:8px; font-size:12px; padding:4px 8px; border:1px solid #ccc; background:#fff; cursor:pointer; }

    .doc-obs { border:1px solid #bbb; min-height:80px; padding:10px; white-space: pre-wrap; margin-top:10px; }

    .doc-footer { border-top:1px solid var(--line); padding-top:8px; margin-top:10px; font-size:11px; color:#555; text-align:center; page-break-inside: avoid; break-inside: avoid; }

    /* ===== PDF multipágina estável ===== */
    thead { display: table-header-group; }
    tfoot { display: table-footer-group; }
    table, tr, td, th, .doc-header, .kv { page-break-inside: avoid; break-inside: avoid; }

    @page { size: A4; margin: 10mm; }
    @media print { header, .controls { display:none !important; } body { background:#fff; } }
  </style>
</head>
<body>
  <header>
    <div class="logos">
      <img id="pdfLogo1" alt="Logo base64" />
      <img id="pdfLogo2" alt="Logo adicional" />
    </div>
    <div class="header-text">
      <h1>Calculadora de Orçamento – Multi‑pacotes</h1>
      <div class="sub">Pré‑visualização fixa em A4 à direita com navegação de páginas. Pacotes 1–6 empilhados + Serviços (7) separado. Logo 1 (BASE64) + Logo 2 (upload).</div>
    </div>
  </header>

  <main>
    <!-- ===================== BLOCO 1: PACOTES 1–6 ===================== -->
    <section>
      <h2>Pacotes 1–6</h2>
      <div class="pane">
        <!-- CONTROLES ESQUERDA -->
        <div class="controls">
          <label for="logoBase64">Logo 1 (BASE64 Data URL)</label>
          <textarea id="logoBase64" placeholder="Cole sua logo como Data URL base64 (ex.: data:image/png;base64,...)" style="font-family: monospace; min-height:70px"></textarea>

          <div class="row">
            <div>
              <label for="logo2Input">Logo 2 (PNG/JPG)</label>
              <input id="logo2Input" type="file" accept="image/*" />
            </div>
            <div>
              <label for="empresa">Empresa/Produtor</label>
              <input id="empresa" type="text" placeholder="Ex.: Estúdio KCM / Seu nome" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="cnpj">CNPJ/CPF (opcional)</label>
              <input id="cnpj" type="text" placeholder="Ex.: 00.000.000/0001-00" />
            </div>
            <div>
              <label for="cliente">Cliente</label>
              <input id="cliente" type="text" placeholder="Nome do cliente" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="validade">Validade (dias)</label>
              <input id="validade" type="number" value="30" />
            </div>
            <div>
              <label for="dataDoc">Data do documento</label>
              <input id="dataDoc" type="text" placeholder="auto" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="titulo">Título do livro</label>
              <input id="titulo" type="text" value="História do PSF em Campina Grande" />
            </div>
            <div>
              <label for="autor">Autor(a)</label>
              <input id="autor" type="text" value="Erinaldo Guimarães" />
            </div>
          </div>

          <label for="pacote">Pacote a adicionar</label>
          <select id="pacote">
            <option value="1">1) Ebook (PDF) + Distribuição Digital — R$ 1.200,00</option>
            <option value="2">2) Ebook (PDF + EPUB/MOBI) + Distribuição Digital — R$ 1.500,00</option>
            <option value="3">3) Ebook (PDF + Audiobook) + Distribuição Digital — R$ 2.200,00</option>
            <option value="4">4) Livro Impresso (serviços completos) — Escolher abaixo</option>
            <option value="5">5) Impresso + Ebook (PDF/EPUB/MOBI) — Escolher abaixo</option>
            <option value="6">6) Impresso + Ebook + Audiobook — Escolher abaixo</option>
          </select>
          <div id="suboptions"></div>

          <label for="obsDoc">Descrição / Observações gerais (para TODO o arquivo)</label>
          <textarea id="obsDoc" placeholder="Texto único usado no final do PDF, independentemente da quantidade de pacotes adicionados."></textarea>

          <div class="btns">
            <button id="btnAddItem">Adicionar pacote</button>
            <button id="btnClearItems" class="soft">Limpar lista</button>
            <button id="btnPDFall" class="secondary">Gerar PDF (todos os pacotes)</button>
          </div>
        </div>

        <!-- PRÉVIA A4 DIREITA -->
        <div>
          <div class="a4-wrap">
            <div id="a4-principal" class="a4">
              <div class="doc-header">
                <div class="logos">
                  <img id="pdfLogo1_top" alt="Logo base64" />
                  <img id="pdfLogo2_top" alt="Logo adicional" />
                </div>
                <div class="htxt">
                  <h3>ORÇAMENTOS DE PRODUÇÃO DE LIVRO (Pacotes 1–6)</h3>
                  <p id="empresaLinha">—</p>
                  <p id="validadeLinha" class="muted">Validade: —</p>
                </div>
              </div>
              <div class="kv">
                <div><strong>Cliente:</strong><span id="kvCliente">—</span></div>
                <div><strong>Data:</strong><span id="kvData">—</span></div>
                <div><strong>Título:</strong><span id="kvTitulo">—</span></div>
                <div><strong>Autor(a):</strong><span id="kvAutor">—</span></div>
              </div>
              <div id="items"></div>
              <div style="margin-top:8px"><strong>Descrição / Observações gerais:</strong></div>
              <div id="obsDocPreview" class="doc-obs"></div>
              <div class="doc-footer">KCM Audiovisual • Emerson Mas • Contato: (83) 99689‑3360</div>
            </div>
          </div>
          <div class="pager" id="pager-principal">
            <button id="prev-principal" class="btnPager">◀ Página anterior</button>
            <span class="info" id="info-principal">Página 1 de 1</span>
            <button id="next-principal" class="btnPager">Próxima página ▶</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ===================== BLOCO 2: SERVIÇOS 7 ===================== -->
    <section>
      <h2>Serviços (Pacote 7)</h2>
      <div class="pane">
        <!-- CONTROLES ESQUERDA -->
        <div class="controls">
          <div class="row">
            <div>
              <label for="cliente7">Cliente</label>
              <input id="cliente7" type="text" placeholder="Nome do cliente" />
            </div>
            <div>
              <label for="validade7">Validade (dias)</label>
              <input id="validade7" type="number" value="30" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="titulo7">Título (opcional)</label>
              <input id="titulo7" type="text" />
            </div>
            <div>
              <label for="autor7">Autor(a) (opcional)</label>
              <input id="autor7" type="text" />
            </div>
          </div>

          <div style="border:1px solid var(--line); padding:10px; background:#fcfcfc;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
              <strong>Selecione os serviços</strong>
              <label style="display:flex; gap:6px; align-items:center; font-size:12px;"><input type="checkbox" id="selTodos7"/> Selecionar todos (R$ 2.130,00)</label>
            </div>
            <div class="svc"><input type="checkbox" class="svcChk7" data-key="copidesque"> Copidesque / Adaptação editorial – <span class="muted">R$ 500,00</span></div>
            <div class="svc"><input type="checkbox" class="svcChk7" data-key="revisao"> Revisão ortográfica e gramatical – <span class="muted">R$ 400,00</span></div>
            <div class="svc"><input type="checkbox" class="svcChk7" data-key="preparacao"> Preparação textual – <span class="muted">R$ 250,00</span></div>
            <div class="svc"><input type="checkbox" class="svcChk7" data-key="diagramacao"> Diagramação – <span class="muted">R$ 400,00</span></div>
            <div class="svc"><input type="checkbox" class="svcChk7" data-key="capa"> Criação de capa e contracapa – <span class="muted">R$ 250,00</span></div>
            <div class="svc"><input type="checkbox" class="svcChk7" data-key="epub"> Conversão para EPUB/MOBI – <span class="muted">R$ 150,00</span></div>
            <div class="svc"><input type="checkbox" class="svcChk7" data-key="ficha"> Ficha catalográfica e ISBN – <span class="muted">R$ 150,00</span></div>
            <div class="svc"><input type="checkbox" class="svcChk7" data-key="registro"> Registro de direitos autorais – <span class="muted">R$ 30,00</span></div>
          </div>

          <label for="obs7">Observações (PDF Serviços)</label>
          <textarea id="obs7" placeholder="Prazos, condições, escopo adicional, etc."></textarea>

          <div class="btns">
            <button id="btnAtualizar7">Atualizar</button>
            <button id="btnPDF7" class="secondary">Gerar PDF (Serviços)</button>
          </div>
        </div>

        <!-- PRÉVIA A4 DIREITA -->
        <div>
          <div class="a4-wrap">
            <div id="a4-servicos" class="a4">
              <div class="doc-header">
                <div class="logos">
                  <img id="pdfLogo1_serv" alt="Logo base64" />
                  <img id="pdfLogo2_serv" alt="Logo adicional" />
                </div>
                <div class="htxt">
                  <h3>ORÇAMENTO DE SERVIÇOS EDITORIAIS (Pacote 7)</h3>
                  <p id="empresaLinha7">—</p>
                  <p id="validadeLinha7" class="muted">Validade: —</p>
                </div>
              </div>
              <div class="kv">
                <div><strong>Cliente:</strong><span id="kvCliente7">—</span></div>
                <div><strong>Data:</strong><span id="kvData7">—</span></div>
                <div><strong>Título (opcional):</strong><span id="kvTitulo7">—</span></div>
                <div><strong>Autor(a) (opcional):</strong><span id="kvAutor7">—</span></div>
              </div>
              <table>
                <thead>
                  <tr><th style="width:45%">Serviço</th><th style="width:35%">Descrição</th><th style="width:20%">Valor (R$)</th></tr>
                </thead>
                <tbody id="tbody7"></tbody>
                <tfoot>
                  <tr>
                    <td colspan="2" style="text-align:right">TOTAL</td>
                    <td id="tdTotal7">R$ 0,00</td>
                  </tr>
                </tfoot>
              </table>
              <p class="muted" id="obsLinha7" style="margin-top:10px"></p>
              <div class="doc-footer">KCM Audiovisual • Emerson Mas • Contato: (83) 99689‑3360</div>
            </div>
          </div>
          <div class="pager" id="pager-servicos">
            <button id="prev-servicos" class="btnPager">◀ Página anterior</button>
            <span class="info" id="info-servicos">Página 1 de 1</span>
            <button id="next-servicos" class="btnPager">Próxima página ▶</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- libs: html2pdf com fallback + espera imagens -->
  <script>
    function ensureHtml2pdf() {
      return new Promise((resolve) => {
        if (window.html2pdf) return resolve();
        const s = document.createElement('script');
        s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
        s.onload = () => resolve();
        s.onerror = () => {
          const s2 = document.createElement('script');
          s2.src = 'https://unpkg.com/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js';
          s2.onload = () => resolve();
          s2.onerror = () => { alert('Não foi possível carregar a biblioteca de PDF. Verifique a conexão.'); };
          document.body.appendChild(s2);
        };
        document.body.appendChild(s);
      });
    }
    function waitForImages(root) {
      const imgs = Array.from(root.querySelectorAll('img'));
      if (imgs.length === 0) return Promise.resolve();
      return Promise.all(imgs.map(img => img.complete ? Promise.resolve() : new Promise(res => { img.onload = res; img.onerror = res; })));
    }
  </script>

  <script>
    const PAGE_PX = 1123;

    // ===================== DADOS PRINCIPAIS (1–6) =====================
    const PRICING = {
      1: { label: '1) Ebook (PDF) + Distribuição Digital', total: 1200.00, material: 'Ebook (PDF); capa frente; revisão; ficha/ISBN; distribuição digital.' },
      2: { label: '2) Ebook (PDF + EPUB/MOBI) + Distribuição Digital', total: 1500.00, material: 'Ebook PDF + EPUB/MOBI; capa frente; revisão; ficha/ISBN; distribuição digital.' },
      3: { label: '3) Ebook (PDF + Audiobook) + Distribuição Digital', total: 2200.00, material: 'Ebook (PDF) + audiobook (3–5h); capa frente; revisão; ficha/ISBN; distribuição digital.' },
      4: { label: '4) Livro Impresso (serviços editoriais completos)', options: [
            {key:'4-500-eco', label:'500 ex. (Qualidade Econômica)', total: 11827.47, material:'Econômico: 150 págs., capa 2 cores (P&B), gramagem básica.'},
            {key:'4-500-pre', label:'500 ex. (Qualidade Premium)', total: 15514.37, material:'Premium: 176 págs., capa Triplex 250 g 4x4, miolo Offset 90 g, BOPP fosca, lombada quadrada.'}
          ]},
      5: { label: '5) Livro Impresso + Ebook (PDF/EPUB/MOBI) + Distribuição', options: [
            {key:'5-500-eco', label:'500 ex. (Qualidade Econômica)', total: 17134.41, material:'Econômico: 150 págs., capa 2 cores (P&B), gramagem básica + eBook (PDF/EPUB/MOBI).'},
            {key:'5-1000-pre', label:'1.000 ex. (Qualidade Premium)', total: 19937.61, material:'Premium: 176 págs., Triplex 250 g 4x4, Offset 90 g, BOPP fosca + eBook (PDF/EPUB/MOBI).'}
          ]},
      6: { label: '6) Livro Impresso + Ebook (PDF/EPUB/MOBI) + Audiobook + Distribuição', options: [
            {key:'6-500-eco', label:'500 ex. (Qualidade Econômica)', total: 20025.00, material:'Econômico: 150 págs., 2 cores; gramagem básica + eBook + audiobook (3–5h).'},
            {key:'6-1000-any', label:'1.000 ex. (Econômica ou Premium)', total: 22069.63, material:'Especificação conforme aprovação (econômica ou premium) + eBook + audiobook (3–5h).'}
          ]}
    };

    const el = (id) => document.getElementById(id);
    const fmt = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    function buildSuboptions() {
      const p = parseInt(el('pacote').value, 10);
      const wrap = el('suboptions');
      wrap.innerHTML = '';
      if ([4,5,6].includes(p)) {
        const s = document.createElement('select'); s.id = 'combo';
        PRICING[p].options.forEach(o => {
          const op = document.createElement('option');
          op.value = o.key; op.textContent = `${o.label} — ${fmt(o.total)}`;
          s.appendChild(op);
        });
        const lab = document.createElement('label'); lab.textContent = 'Quantidade/Qualidade';
        wrap.appendChild(lab); wrap.appendChild(s);
      }
    }

    function headerInfoToPreview() {
      const empresa = el('empresa').value.trim() || '—';
      const cnpj = el('cnpj').value.trim(); // opcional
      el('empresaLinha').textContent = cnpj ? `${empresa} — ${cnpj}` : empresa;
      el('validadeLinha').textContent = `Validade: ${parseInt(el('validade').value || '30', 10)} dias`;
      el('kvTitulo').textContent = el('titulo').value.trim() || '—';
      el('kvAutor').textContent = el('autor').value.trim() || '—';
      el('kvCliente').textContent = el('cliente').value.trim() || '—';
      const dataVal = el('dataDoc').value.trim() || new Date().toLocaleDateString('pt-BR');
      el('kvData').textContent = dataVal;
      el('obsDocPreview').textContent = el('obsDoc').value.trim();
      // logos topo
      el('pdfLogo1_top').src = el('pdfLogo1').src;
      el('pdfLogo2_top').src = el('pdfLogo2').src;
      updatePager('principal');
    }

    let itemCount = 0;
    function addItem() {
      headerInfoToPreview();
      const p = parseInt(el('pacote').value, 10);
      const combo = el('combo') ? el('combo').value : null;

      let tituloPacote = PRICING[p].label;
      let detalhes = '', total = 0;
      if ([1,2,3].includes(p)) {
        detalhes = PRICING[p].material; total = PRICING[p].total;
      } else {
        const opt = PRICING[p].options.find(o => o.key === combo) || PRICING[p].options[0];
        tituloPacote += ' — ' + opt.label; detalhes = opt.material; total = opt.total;
      }

      const id = `item-${++itemCount}`;
      const item = document.createElement('div');
      item.className = 'orc-item'; item.id = id;
      item.innerHTML = `
        <button class="rm" data-id="${id}" title="Remover pacote">Remover</button>
        <h4><strong>${itemCount}.</strong> ${tituloPacote}</h4>
        <table>
          <thead><tr><th style="width:50%">Descrição</th><th style="width:25%">Detalhes</th><th style="width:25%">Valor (R$)</th></tr></thead>
          <tbody><tr><td>${tituloPacote}</td><td>${detalhes}</td><td>${fmt(total)}</td></tr></tbody>
          <tfoot><tr><td colspan="2" style="text-align:right">TOTAL</td><td>${fmt(total)}</td></tr></tfoot>
        </table>
      `;
      el('items').appendChild(item);
      updatePager('principal');
    }

    // Remoção via delegação
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('rm')) {
        const id = e.target.getAttribute('data-id');
        const node = document.getElementById(id);
        if (node) node.remove();
        updatePager('principal');
      }
    });

    function withExpandedNode(node, fn) {
      const prevH = node.style.height, prevO = node.style.overflow, prevST = node.scrollTop;
      node.style.height = 'auto'; node.style.overflow = 'visible'; node.scrollTop = 0;
      return Promise.resolve(fn()).finally(() => { node.style.height = '1123px'; node.style.overflow = 'auto'; node.scrollTop = prevST; });
    }

    async function genPDFAll() {
      headerInfoToPreview();
      await ensureHtml2pdf();
      const node = document.getElementById('a4-principal');
      await waitForImages(node);
      const opt = { margin:[10,10,10,10], filename:`Orcamentos_Pacotes_${new Date().toISOString().slice(0,10)}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true,scrollY:0,letterRendering:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}, pagebreak:{mode:['css','legacy']} };
      await withExpandedNode(node, () => window.html2pdf().set(opt).from(node).save());
    }

    // ===================== SERVIÇOS (7) =====================
    const SERVICOS = {
      copidesque: { nome:'Copidesque / Adaptação editorial', valor:500.00, desc:'Adequação do texto acadêmico para linguagem e estrutura de livro, tornando-o mais fluido e acessível.' },
      revisao:    { nome:'Revisão ortográfica e gramatical', valor:400.00, desc:'Correção de ortografia, gramática, pontuação e concordância.' },
      preparacao: { nome:'Preparação textual', valor:250.00, desc:'Padronização de elementos do texto, remoção de marcações acadêmicas e ajustes técnicos.' },
      diagramacao:{ nome:'Diagramação', valor:400.00, desc:'Organização visual das páginas, fontes, margens, sumário, cabeçalhos e rodapés.' },
      capa:       { nome:'Criação de capa e contracapa', valor:250.00, desc:'Desenvolvimento da capa (frente, lombada e verso) com título e nome do autor.' },
      epub:       { nome:'Conversão para EPUB/MOBI', valor:150.00, desc:'Conversão do livro para formatos compatíveis com Kindle e Kobo.' },
      ficha:      { nome:'Ficha catalográfica e ISBN', valor:150.00, desc:'Elaboração da ficha catalográfica e emissão do número ISBN.' },
      registro:   { nome:'Registro de direitos autorais', valor:30.00,  desc:'Registro da obra na Biblioteca Nacional ou órgão equivalente.' }
    };

    function renderServicos() {
      const empresa = el('empresa').value.trim() || '—';
      const cnpj = el('cnpj').value.trim();
      el('empresaLinha7').textContent = cnpj ? `${empresa} — ${cnpj}` : empresa;
      el('validadeLinha7').textContent = `Validade: ${parseInt(el('validade7').value || '30', 10)} dias`;
      el('kvCliente7').textContent = el('cliente7').value.trim() || '—';
      el('kvTitulo7').textContent = el('titulo7').value.trim() || '—';
      el('kvAutor7').textContent = el('autor7').value.trim() || '—';
      el('kvData7').textContent = new Date().toLocaleDateString('pt-BR');
      el('pdfLogo1_serv').src = el('pdfLogo1').src;
      el('pdfLogo2_serv').src = el('pdfLogo2').src;

      const tbody = el('tbody7'); tbody.innerHTML = '';
      let total = 0; let any = false;
      document.querySelectorAll('.svcChk7').forEach(cb => {
        if (!cb.checked) return; any = true;
        const k = cb.getAttribute('data-key'); const s = SERVICOS[k]; if (!s) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.nome}</td><td>${s.desc}</td><td>${(s.valor).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>`;
        tbody.appendChild(tr); total += s.valor;
      });
      el('tdTotal7').textContent = total.toLocaleString('pt-BR',{style:'currency','currencyDisplay':'symbol'});
      el('obsLinha7').textContent = el('obs7').value.trim();
      updatePager('servicos');
      return any;
    }

    // ===================== Logos =====================
    function applyLogos() {
      const data = el('logoBase64').value.trim();
      if (data && data.startsWith('data:image')) {
        el('pdfLogo1').src = data; el('pdfLogo1_top').src = data; el('pdfLogo1_serv').src = data;
      }
      updatePager('principal'); updatePager('servicos');
    }
    document.getElementById('logo2Input').addEventListener('change', (ev) => {
      const f = ev.target.files?.[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        const src = reader.result; el('pdfLogo2').src = src; el('pdfLogo2_top').src = src; el('pdfLogo2_serv').src = src; updatePager('principal'); updatePager('servicos');
      };
      reader.readAsDataURL(f);
    });

    // ===================== Pager =====================
    function updatePager(which) {
      const box = which === 'principal' ? el('a4-principal') : el('a4-servicos');
      const pager = which === 'principal' ? el('pager-principal') : el('pager-servicos');
      const info = which === 'principal' ? el('info-principal') : el('info-servicos');
      const prev = which === 'principal' ? el('prev-principal') : el('prev-servicos');
      const next = which === 'principal' ? el('next-principal') : el('next-servicos');
      if (!box) return;
      const total = Math.max(1, Math.ceil(box.scrollHeight / PAGE_PX));
      if (total > 1) pager.style.display = 'flex'; else pager.style.display = 'none';
      let idx = parseInt(box.dataset.pageIndex || '0', 10);
      if (idx >= total) idx = total - 1;
      box.dataset.pageIndex = String(idx);
      info.textContent = `Página ${idx + 1} de ${total}`;
      prev.disabled = idx === 0; next.disabled = idx === total - 1;
    }
    function goToPage(which, dir) {
      const box = which === 'principal' ? el('a4-principal') : el('a4-servicos');
      let idx = parseInt(box.dataset.pageIndex || '0', 10);
      const total = Math.max(1, Math.ceil(box.scrollHeight / PAGE_PX));
      idx = Math.min(Math.max(idx + dir, 0), total - 1);
      box.dataset.pageIndex = String(idx);
      box.scrollTo({ top: idx * PAGE_PX, behavior: 'smooth' });
      updatePager(which);
    }
    el('prev-principal').addEventListener('click', () => goToPage('principal', -1));
    el('next-principal').addEventListener('click', () => goToPage('principal', 1));
    el('prev-servicos').addEventListener('click', () => goToPage('servicos', -1));
    el('next-servicos').addEventListener('click', () => goToPage('servicos', 1));

    // ===================== Eventos =====================
    el('pacote').addEventListener('change', buildSuboptions);
    el('btnAddItem').addEventListener('click', addItem);
    el('btnClearItems').addEventListener('click', () => { el('items').innerHTML=''; itemCount=0; updatePager('principal'); });
    el('btnPDFall').addEventListener('click', genPDFAll);

    document.getElementById('selTodos7').addEventListener('change', (e) => { const on = e.target.checked; document.querySelectorAll('.svcChk7').forEach(cb => cb.checked = on); renderServicos(); });
    document.getElementById('btnAtualizar7').addEventListener('click', renderServicos);
    document.getElementById('btnPDF7').addEventListener('click', async () => { const any = renderServicos(); if (!any) { alert('Selecione ao menos um serviço.'); return; } await ensureHtml2pdf(); const node = document.getElementById('a4-servicos'); await waitForImages(node); const opt = { margin:[10,10,10,10], filename:`Orcamento_Servicos_${new Date().toISOString().slice(0,10)}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true,scrollY:0,letterRendering:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}, pagebreak:{mode:['css','legacy']} }; await withExpandedNode(node, () => window.html2pdf().set(opt).from(node).save()); });

    document.addEventListener('input', (e) => {
      if (['empresa','cnpj','cliente','validade','titulo','autor','dataDoc','obsDoc'].includes(e.target.id)) headerInfoToPreview();
      if (['cliente7','validade7','titulo7','autor7','obs7'].includes(e.target.id) || e.target.classList.contains('svcChk7')) renderServicos();
      if (e.target.id === 'logoBase64') applyLogos();
    });

    // Inicialização
    const defaultPixel = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8/x8AAwMCAO1l2bQAAAAASUVORK5CYII=';
    el('logoBase64').value = defaultPixel;
    applyLogos();
    buildSuboptions();
    headerInfoToPreview();
    renderServicos();
    updatePager('principal');
    updatePager('servicos');
  </script>
</body>
</html>
